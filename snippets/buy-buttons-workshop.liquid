{% comment %}
  Renders workshop buy-buttons with premium booking UI.
  Accepts:
  - product: {Object} product object
  - block: {Object} block information
  - product_form_id: {String} product form id
  - section_id: {String} section id
{% endcomment %}

<div {{ block.shopify_attributes }}>
  {%- if product != blank -%}
    {%- liquid
      assign show_dynamic_checkout = false
      if block.settings.show_dynamic_checkout
        assign show_dynamic_checkout = true
      endif
    -%}

    <product-form
      class="product-form product-workshop-form"
      data-hide-errors="false"
      data-section-id="{{ section_id }}"
      data-workshop-booking="true"
    >
      <div class="product-form__error-message-wrapper product-workshop__error" role="alert" hidden>
        <span class="svg-wrapper">
          {{- 'icon-error.svg' | inline_asset_content -}}
        </span>
        <span class="product-form__error-message"></span>
      </div>

      {%- form 'product',
        product,
        id: product_form_id,
        class: 'form product-workshop-form__form',
        novalidate: 'novalidate',
        data-type: 'add-to-cart-form'
      -%}
        <input
          type="hidden"
          name="id"
          value="{{ product.selected_or_first_available_variant.id }}"
          {% if product.selected_or_first_available_variant.available == false %}
            disabled
          {% endif %}
          class="product-variant-id"
        >

        <!-- Premium Workshop Booking Card -->
        <div class="bt-workshop-booking" data-workshop-booking>
          
          <div class="bt-workshop-booking__header">
            <h3 class="bt-workshop-booking__title">Workshop buchen</h3>
            <p class="bt-workshop-booking__subtitle">Wähle Termin, Uhrzeit und Personenanzahl</p>
          </div>

          <div class="bt-workshop-booking__fields">
            
            <!-- Date Field -->
            <div class="bt-workshop-field">
              <label class="bt-workshop-field__label" for="WorkshopDate-{{ section_id }}">
                <span class="bt-workshop-field__icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                  </svg>
                </span>
                Datum
              </label>
              <div class="bt-workshop-field__input-wrap">
                <input
                  id="WorkshopDate-{{ section_id }}"
                  class="bt-workshop-field__input bt-workshop-field__input--date"
                  type="date"
                  name="properties[Workshop-Datum]"
                  required
                  data-booking-required
                  data-booking-field="date"
                >
              </div>
              <span class="bt-workshop-field__error" data-booking-error-for="date" hidden>Bitte Datum wählen</span>
            </div>

            <!-- Time Field -->
            <div class="bt-workshop-field">
              <label class="bt-workshop-field__label" for="WorkshopTime-{{ section_id }}">
                <span class="bt-workshop-field__icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                  </svg>
                </span>
                Uhrzeit
              </label>
              <div class="bt-workshop-field__input-wrap">
                <select
                  id="WorkshopTime-{{ section_id }}"
                  class="bt-workshop-field__input bt-workshop-field__input--select"
                  name="properties[Uhrzeit]"
                  required
                  data-booking-required
                  data-booking-field="time"
                >
                  <option value="" disabled selected>Zeit wählen</option>
                  <option value="09:00">09:00</option>
                  <option value="11:00">11:00</option>
                  <option value="14:00">14:00</option>
                  <option value="16:00">16:00</option>
                  <option value="18:00">18:00</option>
                </select>
              </div>
              <span class="bt-workshop-field__error" data-booking-error-for="time" hidden>Bitte Uhrzeit wählen</span>
            </div>

            <!-- Persons Field with Stepper -->
            <div class="bt-workshop-field">
              <label class="bt-workshop-field__label" for="WorkshopPersons-{{ section_id }}">
                <span class="bt-workshop-field__icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                  </svg>
                </span>
                Personen
              </label>
              <div class="bt-workshop-field__input-wrap">
                <div class="bt-workshop-stepper" role="group" aria-label="Personenanzahl">
                  <button 
                    type="button" 
                    class="bt-workshop-stepper__btn bt-workshop-stepper__btn--minus" 
                    data-booking-step="-1"
                    aria-label="Weniger"
                  >
                    <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                  </button>
                  <input
                    id="WorkshopPersons-{{ section_id }}"
                    class="bt-workshop-stepper__input"
                    type="number"
                    name="properties[Personen]"
                    value="1"
                    min="1"
                    max="20"
                    required
                    data-booking-required
                    data-booking-field="persons"
                  >
                  <button 
                    type="button" 
                    class="bt-workshop-stepper__btn bt-workshop-stepper__btn--plus" 
                    data-booking-step="1"
                    aria-label="Mehr"
                  >
                    <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <line x1="12" y1="5" x2="12" y2="19"></line>
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                  </button>
                </div>
              </div>
              <span class="bt-workshop-field__error" data-booking-error-for="persons" hidden>Bitte Personenanzahl wählen</span>
            </div>

            <!-- Note Field -->
            <div class="bt-workshop-field bt-workshop-field--full">
              <label class="bt-workshop-field__label" for="WorkshopNote-{{ section_id }}">
                <span class="bt-workshop-field__icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="8" y1="6" x2="21" y2="6"></line>
                    <line x1="8" y1="12" x2="21" y2="12"></line>
                    <line x1="8" y1="18" x2="21" y2="18"></line>
                    <line x1="3" y1="6" x2="3.01" y2="6"></line>
                    <line x1="3" y1="12" x2="3.01" y2="12"></line>
                    <line x1="3" y1="18" x2="3.01" y2="18"></line>
                  </svg>
                </span>
                Notiz / Wünsche <span class="bt-workshop-field__optional">(optional)</span>
              </label>
              <div class="bt-workshop-field__input-wrap">
                <textarea
                  id="WorkshopNote-{{ section_id }}"
                  class="bt-workshop-field__input bt-workshop-field__input--textarea"
                  name="properties[Notiz]"
                  rows="3"
                  placeholder="z. B. Allergien, Alter der Teilnehmer, besondere Wünsche"
                  data-booking-field="note"
                ></textarea>
              </div>
            </div>
          </div>
        </div>

        <!-- Submit Buttons -->
        <div class="product-workshop-form__actions">
          <button
            id="ProductSubmitButton-{{ section_id }}"
            type="submit"
            name="add"
            class="product-form__submit button button--full-width button--primary product-workshop-form__submit"
            {% if product.selected_or_first_available_variant.available == false %}
              disabled
            {% endif %}
          >
            <span class="product-workshop-form__submit-text">
              {%- if product.selected_or_first_available_variant.available == false -%}
                Ausverkauft
              {%- else -%}
                In den Warenkorb legen
              {%- endif -%}
            </span>
            {%- render 'loading-spinner' -%}
          </button>
          
          {%- if show_dynamic_checkout -%}
            <div class="product-workshop-form__dynamic-checkout">
              {{ form | payment_button }}
            </div>
          {%- endif -%}
        </div>
      {%- endform -%}
    </product-form>
  {%- else -%}
    <div class="product-form">
      <button type="submit" class="product-form__submit button button--full-width button--primary" disabled>
        Ausverkauft
      </button>
    </div>
  {%- endif -%}
</div>
